#!/bin/bash
set -e

SUDO="/usr/bin/sudo"
JOURNALCTL="/usr/bin/journalctl"
SYSTEMCTL="/usr/bin/systemctl"

SYNC="offlineimap-oneshot@tamu.service"
TIMER="offlineimap-oneshot@tamu.timer"
VAULT="mnt-vault.mount"

case "$1" in
  start|resume)
    "$SYSTEMCTL" --user start "$TIMER"
    ;;

  stop|pause)
    "$SYSTEMCTL" --user stop "$TIMER"
    ;;

  sync)
    if ! "$SYSTEMCTL" is-active --quiet "$VAULT"; then
      "$SUDO" "$SYSTEMCTL" start "$VAULT"
    fi
    "$SYSTEMCTL" --user start "$SYNC"
    ;;

  status)
    "$SYSTEMCTL" --user status "$TIMER" "$SYNC"
    ;;

  log)
    shift
    "$JOURNALCTL" --user --catalog --pager-end --unit "$SYNC" "$@"
    ;;

  *)
    echo "Usage: $0 (pause|resume|sync|status|log)" >&2
    exit 1
    ;;
esac
